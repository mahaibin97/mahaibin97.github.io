OSPF(开放最短路径优先)
=====

> OSPF路由协议是一种链路状态路由协议，是IETF开放的网络标准。

### OSPF的特点

1. 提供了极强的扩展性和快速的收敛性能；

2. OSPF可以做到100%无路由环路；

3. 只支持等价负载均衡；

4. 支持手动汇总；

5. 支持明文认证和MD5认证；

6. 同时，OSPF有了明确的网络规划的理念，有了区域化的概念和层次化的理念。


### OSPF的三张表和五个消息 

###### 三张表

1. 邻居表
   存放着全比邻和非全比邻的邻居信息

2. 链路状态数据库
	相当于EIGRP的拓扑表，但是OSPF的链路状态数据库存放了整个网络的拓扑；
	Hello数据包发送并建立稳定的邻居关系后设备之间会交换LSA信息，用于形成LSDB；

3. 路由表
	存放着到达各个网络的最佳路径

###### 五个消息

1. hello消息
	发现、建立、维护邻接关系；
	发送时间：
		广播型网络   10S
		非广播型网络 30S

2. DBD数据库描述消息
	以简报的形式发送

3. LSR，link state request链路状态请求
	即EIGRP的查询消息

4. LSU 链路状态更新
	回复消息

5. LSACK 链路状态确认消息
	


### OSPF的区域

1. 骨干区域（back bone），即area 0

2. 非骨干区域（non-back bone），area 1-65535

> 常规区域想要互相通讯，就必须经过area 0；
> 常规区域想要访问外部区域，也要经过area 0；

3. 区域的概念针对接口而设定，这就意外着直线相连的两个端口必须位于同一区域

OSPF的区域化加快了路由信息的收敛，，提供了区域化的选项。

4. 末梢区域和孤岛区域

### 路由器角色

1. 区域层面
ABR：区域边界路由器
连接常规区域与骨干区域的路由器才可以被称为ABR；

2. 自制系统层面上
ASBR：自治系统边界路由器
连接不同路由协议与OSPF的路由器（这样的路由器运行在AS间，含OSPF与BGP）

3. 路由信息共享层面上
DR：指定路由器
B-DR：备份指定路由器
DR-OTHER：非DR和非B-DR

这些角色的出现可以减少邻接关系的数量，同时提高路由更新效率。

> DR-other之间无法形成完整的邻接关系；
> DR-other只和DR与B-DR形成完整的邻接关系；
> DR与BDR之间也是完整的邻接关系。

实现这些，才可以达到减少邻接关系的数量，降低网络混乱度，提高路由更新效率。

4. DR/BDR/DR-other的选举过程

每一个广播型网络都会竞选出一个DR，而不是只有一个AS才有。


> Router ID
>用来在AS内标识OSPF路由器的32位二进制数；
>用来标识router 的LSA，选举DR、B-DR；
>生成方式，优选loop back口中最大的IP地址。

(1)侦听状态（40s），尝试发现存在的DR，假设已有DR存在，顶多选出BDR，甚至是DR-other
(2)先竞选出BDR，然后再选出DR；
(3)竞选状态下，优先级（默认为1，遵循越大越优），接口的IP（越大越优）RID
(4)DR一旦选定，除非人为干预，否则不会被取代；
(5)优先级一旦设置为0，就会放弃DR、BDR角色

5. OSPF的RID的由来
1)手动指定（CIL）
2)OSPF自动从环回接口中找到一个IP最大的；
3)如果没有环回接口，OSPF自动的从物理接口中找到一个IP最大的做为RID所需的IP（即root ID）

### 11种LSA

1. 路由器LSA：每台路由器为所属的每个区域生成路由器链路状态通告。LSA 1的链路状态ID是路由器ID。

2. 网络LSA：DR为多路访问网络生成网络链路通告。LSA 2的链路状态ID是DR的IP接口地址。

3. 汇总LSA：ABR将从一个区域中学习到的信息汇总成汇总链路通告，并发给另一个区域。

4. ASBR汇总LSA：ASBR汇总链路状态负责通知OSPF域的其他部分，如何到达ASBR。

5. 自治系统LSA：自治系统外部链路通告由ASBR生成，描述了到达自治系统外部目的网络的路由。

6. LSA 6：组播OSPF应用中使用的专用LSA。

7. LSA 7：在特殊区域类型NSSA中对外部路由使用。

8. LSA 8/9：在OSPF v3中对链路本地地址和区域内前缀使用。

9. LSA 10/11：通用LSA，也称为透明，允许OSPF未来的拓展。


### 不同的路由类型
1. 广播型网络
2. 点到点
3. NBMA：非广播型多链路访问 帧中继 npls PVC标签表
广播型和点到点网络以接口类型区分
现在的接口基本是以太网接口[广播型]
广播型网络之中，两两之间都形成了一个邻接关系。和邻居关系不同，邻居关系要求直接相连。
网络中会充斥着Hello包，为了方便和便于维护，会选举DR BDR。BDR就是备用的DR
其他路由器称为DR OTHER
由DR和BDR发送信息给其他人，DR OTHER只需要和DR还有BDR建立邻接关系

4. 不同的路由类型

4.0 区域内路由
4.1 OIA 区域间路由 
4.2 OE1
4.3 OE2 
4.4 常规外部系统路由
默认情况下，所有外部自治系统路由带进来的路由都用OE2表示，传播过程中开销不累加，一直为20
OE1在传递过程中累加开销值
4.5 ON2
4.6 ON1 9.3/4/5/6）均为外部自治系统路由 5/6特殊区域NSSA

### OSPF选路原理

1. 选举原则：
2. 优先级，默认为1 priority 最大255 取值范围为0~255，一旦优先级设为0，它将一直不会去竞选DR和BDR，一直作为DR OTHER存在。
3. 比较ROUTE ID，大则优。第二位BDR 如果在一个正常运行的网络中，DR BDR都已竞选完成，正常工作中，后期将一台设备的优先级改为最大，不会马上重新选举，除非邻接关系重建[比如其中一台设备down掉]，还是遵循稳定性原则。
4. 点到点/串口网络：串口发出的数据最大只能传输50到100米，一次成型，无法重制。
点到点网络现在比较少见，但如果有两台设备R1 R2直接相连，它们之间还是会形成广播型网络选举DR BDR

### 运行过程：从OSPF刚被激活到能够进行数据转发需要经过七种状态

network：192.168.1.0/24
192.168.1.1   192.168.1.2

R1 R2

**down** down
启用OSPF：init init

**Hello**——>我是192.168.1.1没有看到谁在这条链路上
我是192.168.1.2，有一个邻居是192.168.1.1<——
我是192.168.1.1，收到了来自192.168.1.2的信息——>
……

**two-way**  two-way
路由器怎样判断是否进入two-way状态？
能否从对方Helllo信息中看到邻居是来自本地。

**exstart**——>DBD<——exstart DBD作用是选举主从关系，由主路由器决定数据序列号的起始位置：数据序列号是用于 确保数据传输的可靠性 比较ROUTE ID 大为主路由器
正常情况下序列号范围为：0x80000001——0x7FFFFFFF【每30min更新一次，每更新一次序列号+1，决定谁的信息更新、是否需要同步和接收】

**exchange**——>DBD<——exchange DBD 数据库描述 向外描述本地有哪些网络 直连网络 相当于书的目录 没有明细
如果本地没有，就会向外发送LSR
192.1681.0/24——>
<——172.16.1.0/24
loading LSR链路状态查询

**LSU**
**LSALR**
**full full**

### 路由汇总

OSPF高级特性
RIP和EIGRP在接口下汇总，没有在协议进程下汇总的特性。
OSPF在协议之下汇总，汇总后的子网掩码不能大于主网段。
区域汇总：ABR
外部路由汇总：ASBR

### 认证

RIP 明文密文
EIGRP 密文
认证做在接口下
OSPF有明文密文两种认证
明文 密文
接口 接口
区域 区域
ospf authentication-key ccnp
ip ospf authentication message-digest md5 ccnp

### 校验命令

router#show ip route  //查看路由表
	   show ip ospf database   //查看ospf数据库
	   show ip ospf database router[network/summary/asbr-summary...]  //查看Router LSA等
	   show ip route ospf  //查看ospf路由表
	   show ip route ospf static   //查看ospf静态缺省路由







[参考资料]

1. OSPF v1 ： RFC 1131

2. OSPF v2 ： RFC 2328

3. OSPF v3 ： RFC 5340

3. OSPF Wikipedia·